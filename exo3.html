<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        // Classe représentant une Mairie
        class Mairie {
            constructor(data) {
                this.name = JSON.parse(data.name+'\"}').fr_FR;
                this.averagewaitingtime = data.averagewaitingtime;
                this.isopen = data.isopen;
                this.dayschedule = JSON.parse(data.dayschedule);
            }

            // Méthode pour calculer le nombre total de minutes d'ouverture
            getMinutesOuvertes() {
                return this.dayschedule.reduce((totalMinutes, schedule) => {
                    const openingTime = schedule.openingHour * 60 + schedule.openingMinute;
                    const closingTime = schedule.closingHour * 60 + schedule.closingMinute;
                    return totalMinutes + (closingTime - openingTime);
                }, 0);
            }
        }

        // Fonction pour extraire et trier les mairies ouvertes
        const traiterMairies = (data) => {
            const mairiesOuvertes = data.results
                .map(record => new Mairie(record))  // Créer des instances de la classe Mairie
                .filter(mairie => mairie.isopen)  // Filtrer les mairies ouvertes
                .sort((a, b) => {
                    if (a.averagewaitingtime !== b.averagewaitingtime) {
                        return a.averagewaitingtime - b.averagewaitingtime;
                    } else {
                        return a.name.localeCompare(b.name);  // Tri alphabétique si égalité du temps d'attente
                    }
                });

            console.log('Mairies ouvertes triées :', mairiesOuvertes);

            // Calcul du nombre total de minutes d'ouverture
            const totalMinutesOuvertes = mairiesOuvertes.reduce((total, mairie) => total + mairie.getMinutesOuvertes(), 0);
            console.log('Total de minutes d\'ouverture pour toutes les mairies :', totalMinutesOuvertes);
        };

        // Appel de l'API
        fetch('https://data.strasbourg.eu/api/explore/v2.1/catalog/datasets/duree-dattente-aux-mairies-en-temps-reel/records?limit=20').then(res => {
            if (res.ok) {
                return res.json();
            } else {
                throw new Error('Erreur lors de la requête : ' + res.status);
            }
        }).then(data => traiterMairies(data))
        .catch(error => console.error('Erreur :', error));
    </script>
</body>
</html>
